<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrueStock - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body class="bg-gray-50">
<!-- Header -->
<header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <i class="fas fa-boxes text-blue-600 text-2xl mr-3"></i>
                <h1 class="text-xl font-semibold text-gray-900">TrueStock</h1>
            </div>
            <nav class="flex space-x-8">
                <a href="dashboard.html" class="text-blue-600 border-b-2 border-blue-600 px-1 pt-1 pb-4 text-sm font-medium">Dashboard</a>
                <a href="inventario.html" class="text-gray-500 hover:text-gray-700 px-1 pt-1 pb-4 text-sm font-medium">Inventario</a>
                <a href="ocr.html" class="text-gray-500 hover:text-gray-700 px-1 pt-1 pb-4 text-sm font-medium">Escanear</a>
            </nav>
        </div>
    </div>
</header>

<!-- Loading -->
<div id="loading" class="fixed inset-0 bg-gray-50 flex items-center justify-center z-50">
    <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">Cargando dashboard...</p>
    </div>
</div>

<!-- Main Content -->
<main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8" style="display: none;" id="main-content">
    <!-- Métricas Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- Total Productos -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-boxes text-blue-500 text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Total Productos</p>
                    <p class="text-2xl font-semibold text-gray-900" id="total-productos">-</p>
                </div>
            </div>
        </div>

        <!-- Stock Bajo -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Stock Bajo</p>
                    <p class="text-2xl font-semibold text-gray-900" id="stock-bajo">-</p>
                </div>
            </div>
        </div>

        <!-- Valor Inventario -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-dollar-sign text-green-500 text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Valor Inventario</p>
                    <p class="text-2xl font-semibold text-gray-900" id="valor-inventario">-</p>
                </div>
            </div>
        </div>

        <!-- Facturas Hoy -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-file-invoice text-purple-500 text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Facturas Hoy</p>
                    <p class="text-2xl font-semibold text-gray-900" id="facturas-hoy">-</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Alertas de Stock -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                        Alertas de Stock Bajo
                    </h3>
                    <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium" id="alertas-count">0</span>
                </div>
                <div id="alertas-container" class="space-y-3">
                    <!-- Alertas se cargarán aquí -->
                </div>
            </div>
        </div>

        <!-- Acciones Rápidas -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">
                    <i class="fas fa-bolt text-blue-500 mr-2"></i>
                    Acciones Rápidas
                </h3>
                <div class="space-y-3">
                    <button onclick="window.location.href='ocr.html'" class="w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                        <i class="fas fa-camera mr-2"></i>
                        Escanear Factura
                    </button>
                    <button onclick="window.location.href='inventario.html'" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                        <i class="fas fa-list mr-2"></i>
                        Ver Inventario
                    </button>
                    <button onclick="agregarProducto()" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        Agregar Producto
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Error Message -->
<div id="error-message" class="hidden fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50">
    <div class="flex">
        <i class="fas fa-exclamation-circle mr-2 mt-1"></i>
        <div>
            <strong>Error:</strong>
            <span id="error-text">No se pudo conectar con el servidor</span>
        </div>
    </div>
</div>

<script>
    // Configuración de la API
    const API_BASE_URL = 'http://localhost:8080';

    // Configurar axios
    axios.defaults.baseURL = API_BASE_URL;
    axios.defaults.timeout = 10000;

    // Estado global
    let dashboardData = {
        metricas: {},
        alertas: []
    };

    // Inicializar dashboard
    async function initDashboard() {
        try {
            await Promise.all([
                cargarMetricas(),
                cargarAlertasStock()
            ]);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        } catch (error) {
            console.error('Error inicializando dashboard:', error);
            mostrarError('No se pudo cargar el dashboard');

            // Mostrar datos de ejemplo si falla la API
            mostrarDatosEjemplo();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        }
    }

    // Cargar métricas del dashboard
    async function cargarMetricas() {
        try {
            const response = await axios.get('/api/v1/inventario/metricas');
            dashboardData.metricas = response.data;
            actualizarMetricas(response.data);
        } catch (error) {
            console.error('Error cargando métricas:', error);
            throw error;
        }
    }

    // Cargar alertas de stock bajo
    async function cargarAlertasStock() {
        try {
            const response = await axios.get('/api/v1/inventario/alertas-stock');
            dashboardData.alertas = response.data;
            actualizarAlertas(response.data);
        } catch (error) {
            console.error('Error cargando alertas:', error);
            throw error;
        }
    }

    // Actualizar métricas en la UI
    function actualizarMetricas(metricas) {
        document.getElementById('total-productos').textContent = metricas.totalProductos || 0;
        document.getElementById('stock-bajo').textContent = metricas.productosStockBajo || 0;
        document.getElementById('valor-inventario').textContent =
            new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' })
                .format(metricas.valorInventario || 0);
        document.getElementById('facturas-hoy').textContent = metricas.facturasHoy || 0;
    }

    // Actualizar alertas en la UI
    function actualizarAlertas(alertas) {
        const container = document.getElementById('alertas-container');
        const countElement = document.getElementById('alertas-count');

        countElement.textContent = alertas.length;

        if (alertas.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-check-circle text-green-500 text-4xl mb-2"></i>
                    <p>¡Excelente! No hay alertas de stock bajo</p>
                </div>
            `;
            return;
        }

        container.innerHTML = alertas.map(alerta => `
            <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                    <div>
                        <p class="font-medium text-gray-900">${alerta.producto}</p>
                        <p class="text-sm text-gray-600">
                            Stock actual: ${alerta.stockActual} | Mínimo: ${alerta.stockMinimo}
                        </p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-medium">
                        ${alerta.categoria}
                    </span>
                </div>
            </div>
        `).join('');
    }

    // Mostrar datos de ejemplo si la API no está disponible
    function mostrarDatosEjemplo() {
        const metricasEjemplo = {
            totalProductos: 156,
            productosStockBajo: 12,
            valorInventario: 4582000,
            facturasHoy: 8
        };

        const alertasEjemplo = [
            {
                producto: 'Aceite Motor 5W30',
                stockActual: 3,
                stockMinimo: 10,
                categoria: 'Lubricantes'
            },
            {
                producto: 'Filtro Aire K&N',
                stockActual: 1,
                stockMinimo: 5,
                categoria: 'Filtros'
            },
            {
                producto: 'Batería 12V 60Ah',
                stockActual: 0,
                stockMinimo: 3,
                categoria: 'Eléctrico'
            }
        ];

        actualizarMetricas(metricasEjemplo);
        actualizarAlertas(alertasEjemplo);
    }

    // Mostrar mensaje de error
    function mostrarError(mensaje) {
        document.getElementById('error-text').textContent = mensaje;
        document.getElementById('error-message').classList.remove('hidden');

        setTimeout(() => {
            document.getElementById('error-message').classList.add('hidden');
        }, 5000);
    }

    // Funciones de acciones rápidas
    function agregarProducto() {
        // Redirigir a página de agregar producto o mostrar modal
        window.location.href = 'inventario.html#agregar';
    }

    // Actualizar dashboard cada 30 segundos
    setInterval(() => {
        cargarMetricas().catch(() => {});
        cargarAlertasStock().catch(() => {});
    }, 30000);

    // Inicializar cuando se carga la página
    document.addEventListener('DOMContentLoaded', initDashboard);
</script>
</body>
</html>